# Task: CLI Server Control - make cliの画面でサーバー起動・停止機能

## 現在のフェーズ
Phase 5: REFACTOR - 完了

## 進捗
| Phase | Agent | Status | 成果物 |
|-------|-------|--------|--------|
| 1. 設計 | architect | ✅ | .task_status.md |
| 2. テスト設計 | test-designer | ✅ | test_design/test_design_server_control.md |
| 3. RED | test-writer | ✅ | tests/test_server_manager.py |
| 4. GREEN | implementer | ✅ | cli.py, services/server_manager.py |
| 5. REFACTOR | reviewer | ✅ | - |

## 要件分析

### 機能概要
CLI画面上でバックエンドサーバー(uvicorn)とフロントエンドサーバー(vite)の起動・停止を制御できるようにする。

### 現状の課題
- 現在のCLIは表示のみで、サーバー制御機能がない
- サーバーの起動・停止は別ターミナルで `make start` / `make stop` を実行する必要がある
- サーバーの状態がCLI上で確認できない

### 要求機能
1. **サーバー状態表示**: Backend/Frontendの起動状態をリアルタイム表示
2. **キーボードショートカット**:
   - `s` キー: サーバー起動 (start)
   - `x` キー: サーバー停止 (stop)
   - `r` キー: サーバー再起動 (restart)
   - `q` / `Ctrl+C`: CLI終了
3. **プロセス管理**: 子プロセスとしてサーバーを管理

### 技術設計

#### モジュール構成
```
backend/
├── cli.py                    # メインCLI (修正)
└── services/
    └── server_manager.py     # 新規: サーバー管理クラス
```

#### ServerManager クラス設計
```python
class ServerManager:
    """Backend/Frontendサーバーのプロセス管理"""

    def __init__(self):
        self.backend_process: subprocess.Popen | None
        self.frontend_process: subprocess.Popen | None

    def start_backend(self) -> bool: ...
    def stop_backend(self) -> bool: ...
    def start_frontend(self) -> bool: ...
    def stop_frontend(self) -> bool: ...
    def start_all(self) -> tuple[bool, bool]: ...
    def stop_all(self) -> tuple[bool, bool]: ...
    def restart_all(self) -> tuple[bool, bool]: ...
    def is_backend_running(self) -> bool: ...
    def is_frontend_running(self) -> bool: ...
    def get_status(self) -> dict[str, bool]: ...
```

#### キーボード入力処理
- `rich` の `Console` と非同期入力を組み合わせる
- または `keyboard` ライブラリを使用（別途検討）
- macOSの場合は `select` + `sys.stdin` で対応可能

#### UI更新
- ヘッダー部分にサーバー状態インジケータを追加
- フッターにキーボードショートカットのヘルプを表示

### エッジケース考慮
1. **サーバー起動失敗**: ポート使用中、依存関係エラー
2. **サーバー停止失敗**: プロセスが応答しない
3. **外部からのサーバー操作**: CLI外から起動/停止された場合の検出
4. **シグナル処理**: CLI終了時のクリーンアップ
5. **並行操作**: 起動中に停止コマンドが来た場合

### 依存関係
- subprocess (標準ライブラリ)
- asyncio (標準ライブラリ)
- psutil (プロセス監視用、追加が必要)

## 次フェーズへの引継ぎ
- ServerManager クラスのユニットテストを設計
- キーボード入力ハンドリングのテストを設計
- UI状態表示のテストを設計
